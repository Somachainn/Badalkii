<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Laam P2P (GitHub Pages)</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <style>
    /* Minimal, mobile-first styles */
    :root{--blue:#1467ff;--bg:#f7fbff;--card:#ffffff}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,var(--bg),#fff);padding:18px;color:#0b1220}
    .container{max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px}
    .logo{width:52px;height:52px;border-radius:10px;background:linear-gradient(135deg,var(--blue),#4fb3ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:16px}
    @media(min-width:880px){.grid{grid-template-columns:360px 1fr}}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(16,24,40,0.06)}
    label{display:block;font-size:13px;margin-top:8px}
    input,select,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e6eef9;margin-top:6px}
    button{background:var(--blue);color:#fff;padding:10px 12px;border-radius:10px;border:0;cursor:pointer}
    .muted{color:#6b7280;font-size:13px}
    .orders-list{display:flex;flex-direction:column;gap:10px}
    .order{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;border:1px solid #eef6ff}
    .small{font-size:13px}
    .pill{background:#eef7ff;padding:6px 10px;border-radius:999px;font-weight:600}
    .success{background:#e6ffef;color:#067a3d;padding:6px 10px;border-radius:8px}
    .warn{background:#fff6e6;color:#b45309;padding:6px 10px;border-radius:8px}
    .note{font-size:13px;color:#374151}
    .row{display:flex;gap:8px;align-items:center}
    .flex{display:flex;gap:8px;align-items:center}
    .center{display:flex;align-items:center;justify-content:center}
    .tximg{max-width:120px;border-radius:8px;border:1px solid #e6eef9}
    a.link{color:var(--blue);text-decoration:none}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">LM</div>
      <div>
        <h1>Laam P2P — ETB / USDT (Demo)</h1>
        <div class="muted">Frontend static app ready for GitHub Pages • Connects to Supabase</div>
      </div>
    </header><div class="grid">
  <!-- LEFT: Create Order + Wallet -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>
        <strong>Create order</strong>
        <div class="muted small">Post a buy or sell offer (public orderbook)</div>
      </div>
      <div class="flex">
        <button id="btnConnect">Connect Wallet</button>
      </div>
    </div>

    <form id="orderForm" style="margin-top:12px">
      <label>Order type</label>
      <select id="order_type"><option value="sell">Sell USDT (Get ETB)</option><option value="buy">Buy USDT (Pay ETB)</option></select>

      <label>Amount (USDT)</label>
      <input id="amount" type="number" step="0.0001" value="10" />

      <label>Price (ETB per USDT)</label>
      <input id="price" type="number" step="0.01" value="60.00" />

      <label>Payment Method</label>
      <select id="payment_method"><option>Telebirr</option><option>CBE Birr</option><option>Bank Transfer</option></select>

      <label>Notes (instructions to buyer/seller)</label>
      <textarea id="notes" rows="3" placeholder="e.g. Send to Telebirr 091... and upload receipt"></textarea>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button type="submit">Post Order</button>
        <button id="btnRefresh" type="button" style="background:#fff;border:1px solid #e6eef9;color:#0b1220">Refresh</button>
      </div>
    </form>

    <hr style="margin:12px 0" />
    <div class="muted small">Your wallet: <span id="walletAddr">not connected</span></div>
    <div class="muted small">Supabase: <span id="sbStatus">not initialized</span></div>
  </div>

  <!-- RIGHT: Orderbook + Match actions -->
  <div>
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>Open Orders</strong><div class="muted small">Buyers & sellers (public)</div></div>
        <div class="muted small">Filter: <select id="filterType"><option value="all">All</option><option value="buy">Buy</option><option value="sell">Sell</option></select></div>
      </div>

      <div id="orders" class="orders-list" style="margin-top:12px;max-height:520px;overflow:auto">
        <!-- orders inserted here -->
      </div>
    </div>

    <div class="card">
      <strong>Match & Trade (Demo)</strong>
      <div class="muted small">Click "Match" to create a trade between you and the order poster. This demo uses Supabase tables directly.</div>
      <div style="margin-top:10px" id="tradeBox"></div>
    </div>
  </div>
</div>

<footer style="margin-top:18px;font-size:13px;color:#6b7280">Notes: This is a **frontend-only demo** that expects a Supabase project with the tables <code>users, orders, trades, payments, disputes</code> created (SQL schema). Replace <strong>SUPABASE_URL</strong> and <strong>SUPABASE_ANON_KEY</strong> with your project's values inside the script. Enable CORS for the domain where you deploy (or allow all origins for testing).</footer>

  </div>  <!-- Supabase JS (CDN) -->  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/index.min.js"></script>  <script>
    // -------------------------------
    // CONFIG — REPLACE with your Supabase values
    // -------------------------------
    const SUPABASE_URL = 'https://REPLACE_WITH_YOUR_SUPABASE_PROJECT.supabase.co';
    const SUPABASE_ANON_KEY = 'REPLACE_WITH_ANON_KEY';

    // -------------------------------
    // Initialize Supabase
    // -------------------------------
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const sbStatusEl = document.getElementById('sbStatus');
    async function checkSupabase(){
      try{
        const { data } = await sb.from('orders').select('id').limit(1);
        sbStatusEl.textContent = 'connected';
      }catch(e){
        sbStatusEl.textContent = 'error — check keys & CORS';
        console.error(e);
      }
    }
    checkSupabase();

    // -------------------------------
    // Wallet Connect (Metamask basic)
    // -------------------------------
    const btnConnect = document.getElementById('btnConnect');
    const walletAddrEl = document.getElementById('walletAddr');
    let walletAddress = null;
    btnConnect.addEventListener('click', async ()=>{
      if(window.ethereum){
        try{
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          walletAddress = accounts[0];
          walletAddrEl.textContent = walletAddress;
          btnConnect.textContent = 'Connected';
        }catch(e){
          console.error(e);
          alert('Could not connect wallet');
        }
      }else{
        alert('No Web3 wallet found in browser. Use Metamask mobile or a compatible browser.');
      }
    });

    // -------------------------------
    // Load open orders
    // -------------------------------
    const ordersEl = document.getElementById('orders');
    const filterType = document.getElementById('filterType');

    async function loadOrders(){
      ordersEl.innerHTML = '<div class="muted small center">Loading...</div>';
      const ft = filterType.value;
      let q = sb.from('orders').select('*').eq('status','open').order('created_at',{ascending:false});
      if(ft !== 'all') q = q.eq('order_type', ft);
      const { data, error } = await q;
      if(error){ ordersEl.innerHTML = '<div class="muted">Could not load orders</div>'; console.error(error); return; }
      if(!data || data.length === 0){ ordersEl.innerHTML = '<div class="muted">No orders yet</div>'; return; }

      ordersEl.innerHTML = '';
      data.forEach(o=>{
        const div = document.createElement('div'); div.className='order';
        const left = document.createElement('div'); left.innerHTML = `<div style="font-weight:700">${o.order_type.toUpperCase()} • ${o.asset}</div><div class="small muted">Posted: ${new Date(o.created_at).toLocaleString()}</div><div class="muted small">${o.notes || ''}</div>`;
        const right = document.createElement('div');
        right.innerHTML = `<div class="pill">${Number(o.amount).toLocaleString()} ${o.asset}</div><div class="muted small">Price: ${Number(o.price).toLocaleString()} ${o.fiat_currency}</div><div style="margin-top:8px" class="row"><button data-id="${o.id}" class="btnMatch">Match</button><button data-id="${o.id}" class="btnView muted" style="background:#fff;border:1px solid #eef6ff;color:#0b1220">View</button></div>`;
        div.appendChild(left); div.appendChild(right);
        ordersEl.appendChild(div);
      });

      // attach match handlers
      document.querySelectorAll('.btnMatch').forEach(b=> b.addEventListener('click', onMatch));
    }

    filterType.addEventListener('change', loadOrders);
    document.getElementById('btnRefresh').addEventListener('click', loadOrders);
    loadOrders();

    // -------------------------------
    // Post order
    // -------------------------------
    const orderForm = document.getElementById('orderForm');
    orderForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const order_type = document.getElementById('order_type').value;
      const amount = Number(document.getElementById('amount').value);
      const price = Number(document.getElementById('price').value);
      const payment_method = document.getElementById('payment_method').value;
      const notes = document.getElementById('notes').value;

      if(!walletAddress){ if(!confirm('No wallet connected. Post using guest account?')) return; }

      const payload = {
        user_id: walletAddress ? walletAddress : null,
        order_type, asset: 'USDT', fiat_currency: 'ETB', amount, price, payment_method, notes, status: 'open'
      };

      const { data, error } = await sb.from('orders').insert([payload]).select().single();
      if(error){ alert('Could not post order — check console'); console.error(error); return; }
      alert('Order posted'); orderForm.reset(); loadOrders();
    });

    // -------------------------------
    // Match flow (create trade)
    // -------------------------------
    async function onMatch(e){
      const orderId = e.currentTarget.dataset.id;
      // load order
      const { data: orders } = await sb.from('orders').select('*').eq('id', orderId).single();
      if(!orders){ alert('Order not found'); return; }
      // quick demo: create trade where current wallet is taker
      const buyer = orders.order_type === 'sell' ? (walletAddress || null) : orders.user_id;
      const seller = orders.order_type === 'sell' ? orders.user_id : (walletAddress || null);

      const tradePayload = {
        order_id: orderId,
        buyer_id: buyer,
        seller_id: seller,
        amount: orders.amount,
        fiat_amount: Number(orders.amount) * Number(orders.price),
        status: 'pending'
      };

      const { data: tdata, error } = await sb.from('trades').insert([tradePayload]).select().single();
      if(error){ alert('Could not create trade — check console'); console.error(error); return; }

      // mark order matched
      await sb.from('orders').update({ status: 'matched' }).eq('id', orderId);
      document.getElementById('tradeBox').innerHTML = `<div class="muted small">Trade created: <strong>${tdata.id}</strong>. Ask buyer to upload payment receipt in "My Trades" (not implemented in this demo).</div>`;
      loadOrders();
    }

    // -------------------------------
    // Realtime: listen to new orders
    // -------------------------------
    try{
      sb.channel('public:orders')
        .on('postgres_changes', { event: '*', schema: 'public', table: 'orders' }, payload => { loadOrders(); })
        .subscribe();
    }catch(e){ console.warn('Realtime init might fail in local testing', e); }

  </script></body>
</html>
