<!DOCTYPE html>
<html lang="so">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Laam Wallet & DEX (Laam / XLM)</title>

<!-- Stellar SDK + CryptoJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/stellar-sdk/10.5.1/stellar-sdk.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

<style>
:root{
  --bg1:#0f2027; --bg2:#203a43; --bg3:#2c5364;
  --card:#1e2a38; --card2:#22354b;
  --text:#e6eef6; --muted:#9fb2c6;
  --accent:#ffd36b; --accent2:#ffca3a;
  --ok:#28a745; --err:#ff6b6b;
  --rad:14px; --maxw:980px;
}
*{box-sizing:border-box}
body{
  margin:0; font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
  color:var(--text); padding:26px; display:flex; justify-content:center;
}
.app{width:100%; max-width:var(--maxw);}
h1{margin:0 0 18px; text-align:center; color:var(--accent); font-size:2.1rem; text-shadow:0 0 8px var(--accent)}
.card{background:linear-gradient(180deg,#0f1b24, #11262f); border-radius:var(--rad); padding:16px; margin:12px 0; border:1px solid rgba(255,255,255,0.02);}
.row{margin:10px 0}
label{display:block;color:var(--accent); font-weight:700; margin-bottom:8px}
input,select,button,textarea{
  width:100%; padding:10px 12px; border-radius:12px; border:none;
  background:#0e2a38; color:var(--text); font-size:1rem;
}
input::placeholder, textarea::placeholder{color:#6a7a88}
button{background:var(--accent); color:#071422; font-weight:800; cursor:pointer; box-shadow:0 6px 20px rgba(255,211,107,0.12); text-transform:uppercase}
button.btn-secondary{background:#22425a; color:var(--text); box-shadow:none}
button.btn-danger{background:var(--err); color:white}

/* layout */
.grid2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
@media(max-width:820px){ .grid2{grid-template-columns:1fr} }

.mono{font-family:ui-monospace, Menlo, Monaco, "Courier New", monospace; background:#0b1b25; padding:10px; border-radius:10px; word-break:break-all}
.pill{background:#0b2430; padding:8px 12px; border-radius:999px; display:inline-block; color:var(--accent)}
.small{font-size:.9rem; color:var(--muted)}
.table{width:100%; border-collapse:collapse; margin-top:8px}
.table th,.table td{padding:8px 10px; text-align:right}
.table th{color:var(--accent); text-align:left}
.table tr:hover td{background:#0d2a36}
.center{text-align:center}

/* Trade area */
.trade-header{display:flex; justify-content:space-between; align-items:center; padding:10px 0}
.asset-box{display:flex; align-items:center; gap:8px}
.asset-box img{width:34px;height:34px;border-radius:8px}
.tabs{display:flex; gap:6px; margin-top:8px}
.tab{padding:8px 12px; border-radius:10px; background:#0e2a38; cursor:pointer; color:var(--muted); font-weight:700}
.tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#071422; box-shadow:0 6px 20px rgba(255,211,107,0.12)}

/* modal */
.modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.6); z-index:1000}
.modal.show{display:flex}
.modal-card{width:94%; max-width:520px; background:linear-gradient(180deg,#0f1b24,#0b1b25); padding:18px; border-radius:12px; border:1px solid rgba(255,255,255,0.02)}

/* small helpers */
.row-buttons{display:flex; gap:8px}
.row-buttons button{flex:1}
.bad{color:var(--err)}
.ok{color:var(--ok)}
</style>
</head>
<body>
  <div class="app">
    <h1>Laam Wallet & DEX</h1>

    <!-- AUTH card -->
    <div id="authCard" class="card">
      <div class="grid2">
        <div>
          <label>Secret Key (S…)</label>
          <input id="secretInput" type="password" placeholder="Starts with S..." />
        </div>
        <div>
          <label>Create Password (to save local)</label>
          <input id="savePwd" type="password" placeholder="Min 8 characters" />
        </div>
      </div>
      <div class="row row-buttons">
        <button id="importSaveBtn">Import & Save</button>
        <button id="generateBtn" class="btn-secondary">Generate New</button>
      </div>

      <div id="generatedKeys" class="row" style="display:none">
        <label>Generated Secret</label>
        <div id="genSecret" class="mono">-</div>
        <label>Generated Public</label>
        <div id="genPublic" class="mono">-</div>
        <div class="small" style="margin-top:8px">Fund the generated public key with ≥ 2 XLM on mainnet to activate.</div>
      </div>

      <div id="unlockArea" class="row" style="margin-top:12px; display:none">
        <label>Unlock saved wallet (password)</label>
        <input id="unlockPwd" type="password" placeholder="Your password" />
        <div class="row row-buttons">
          <button id="unlockBtn">Unlock</button>
          <button id="forgetBtn" class="btn-secondary">Forget Saved</button>
        </div>
      </div>
    </div>

    <!-- WALLET view -->
    <div id="walletCard" class="card" style="display:none">
      <!-- Portfolio top -->
      <div class="grid2">
        <div>
          <div class="small">Portfolio Value</div>
          <div style="font-size:1.6rem; font-weight:800">$<span id="portfolioUsd">0.00</span></div>
          <div class="small">Breakdown: <span id="breakdownText">-</span></div>
        </div>
        <div class="center">
          <div class="small">Status</div>
          <div class="pill">Connected</div>
        </div>
      </div>

      <!-- buttons -->
      <div class="row row-buttons" style="margin-top:12px">
        <button id="btnSend">Send</button>
        <button id="btnReceive" class="btn-secondary">Receive</button>
        <button id="btnTrust" class="btn-secondary">Add Laam Trustline</button>
        <button id="btnLock" class="btn-danger">Lock</button>
      </div>

      <!-- balances -->
      <div class="row" style="margin-top:14px">
        <label>Balances</label>
        <div style="display:flex; gap:12px; flex-wrap:wrap">
          <div class="mono" style="padding:10px 14px">XLM: <strong id="balXlm">0</strong></div>
          <div class="mono" style="padding:10px 14px">Laam: <strong id="balLaam">0</strong></div>
          <div class="mono" style="padding:10px 14px">Public Key: <div id="pubKey" style="margin-top:6px; font-weight:700; display:inline-block"></div></div>
        </div>
      </div>
    </div>

    <!-- TRADE card -->
    <div class="card">
      <div class="trade-header">
        <div class="asset-box">
          <img src="https://i.ibb.co/r28SP1bN/20250802-225108.png" alt="Laam">
          <div>
            <div style="font-weight:800">Laam</div>
            <div class="small">Issuer: laam.online</div>
          </div>
        </div>
        <div class="small">Pair: <span class="pill">Laam / XLM</span></div>
      </div>

      <div class="tabs" style="margin-top:12px">
        <div class="tab active" id="tabOverview">Overview</div>
        <div class="tab" id="tabOrderbook">Orderbook</div>
        <div class="tab" id="tabTrades">Last Trades</div>
      </div>

      <!-- Overview -->
      <div id="overviewPanel" style="padding:12px 0">
        <div style="text-align:center; margin-bottom:8px">
          <div style="font-size:1.6rem; font-weight:900" id="laamPriceXlm">0.0000000</div>
          <div class="small" id="priceTime">-</div>
        </div>
        <div style="display:flex; gap:8px; justify-content:center; margin-bottom:10px">
          <button class="btn-secondary" data-range="1D">1D</button>
          <button class="btn-secondary" data-range="1W">1W</button>
          <button class="btn-secondary" data-range="1M">1M</button>
          <button class="btn-secondary" data-range="1Y">1Y</button>
        </div>
        <div id="overviewChart" style="height:160px; background:#071422; border-radius:10px; display:flex; align-items:center; justify-content:center; color:var(--muted)">Chart placeholder</div>
      </div>

      <!-- Orderbook -->
      <div id="orderbookPanel" style="display:none; padding-top:12px">
        <table class="table">
          <thead><tr><th>Amount (Laam)</th><th>Price (XLM)</th><th>Total (XLM)</th></tr></thead>
          <tbody id="asksBody"></tbody>
        </table>
        <div class="small center" id="spreadText">Spread: -</div>
        <table class="table" style="margin-top:10px">
          <tbody id="bidsBody"></tbody>
        </table>
      </div>

      <!-- Last trades -->
      <div id="tradesPanel" style="display:none; padding-top:12px">
        <table class="table">
          <thead><tr><th>When</th><th>Price (XLM)</th><th>Amount (Laam)</th></tr></thead>
          <tbody id="tradesBody"></tbody>
        </table>
      </div>

      <!-- Buy / Sell actions -->
      <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap">
        <button id="openBuy" class="btn-buy" style="flex:1; background:var(--accent)">Buy Laam</button>
        <button id="openSell" class="btn-sell" style="flex:1; background:#f87171">Sell Laam</button>
      </div>
    </div>
  </div>

  <!-- BUY/SELL MODAL -->
  <div id="tradeModal" class="modal">
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div style="font-weight:900" id="modalTitle">Buy Laam</div>
        <button class="modal-close" onclick="closeTradeModal()">✕</button>
      </div>

      <div class="panel">
        <div class="titleRow" style="display:flex; justify-content:space-between; margin-bottom:8px">
          <div class="small">Available: <span id="availBal">0</span></div>
          <div class="small">Pair: Laam/XLM</div>
        </div>

        <div class="field">
          <label>Price (XLM per Laam)</label>
          <input id="modalPrice" type="number" step="0.0000001" placeholder="e.g. 0.135" />
        </div>

        <div class="field">
          <label>Amount (Laam)</label>
          <input id="modalAmount" type="number" step="0.0000001" placeholder="How many Laam" />
          <div style="display:flex; gap:6px; margin-top:8px">
            <button class="btn-secondary" data-fill="25">25%</button>
            <button class="btn-secondary" data-fill="50">50%</button>
            <button class="btn-secondary" data-fill="75">75%</button>
            <button class="btn-secondary" data-fill="100">100%</button>
          </div>
        </div>

        <div class="field">
          <label>Total (XLM)</label>
          <input id="modalTotal" disabled />
          <div class="small" id="modalHint">Total XLM to pay (buy) or to receive (sell)</div>
        </div>

        <div style="display:flex; gap:8px">
          <button id="confirmTrade" style="flex:1" class="btn-buy">Confirm</button>
          <button onclick="closeTradeModal()" class="btn-secondary" style="flex:1">Cancel</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RECEIVE modal -->
  <div id="recvModal" class="modal">
    <div class="modal-card">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
        <div style="font-weight:900">Receive</div>
        <button class="modal-close" onclick="toggleReceive(false)">✕</button>
      </div>
      <div>
        <div class="small">Share this public key to receive assets</div>
        <div id="recvPub" class="mono" style="margin-top:8px">-</div>
        <div style="display:flex; gap:8px; margin-top:10px">
          <button id="copyPub" class="btn-secondary">Copy</button>
          <a id="openQr" class="btn-secondary" target="_blank">Open QR</a>
        </div>
      </div>
    </div>
  </div>

<script>
/* -----------------------------
   Configuration & State
   -----------------------------*/
const server = new StellarSdk.Server('https://horizon.stellar.org');
const ISSUER = 'GAL4ECDAXNBMJYFCWIJ32HKVIRLCNEXY664CAZYI3EINQWPLXTMEPR64';
const LAAM = new StellarSdk.Asset('Laam', ISSUER);
const XLM = StellarSdk.Asset.native();
const STORE_KEY = 'laam_wallet_enc_v1';

let keypair = null;
let account = null;
let bestAsk = null, bestBid = null;
let pollTimer = null;

/* -----------------------------
   Helpers
   -----------------------------*/
const $ = (s)=>document.querySelector(s);
const $$ = (s)=>document.querySelectorAll(s);
const fmt = (n, d=2)=> (Number(n)||0).toFixed(d);
const encrypt = (secret,pwd)=> CryptoJS.AES.encrypt(secret,pwd).toString();
const decrypt = (enc,pwd)=> {
  try{ const bytes = CryptoJS.AES.decrypt(enc,pwd); return bytes.toString(CryptoJS.enc.Utf8); } catch{return '';}
};

/* -----------------------------
   AUTH UI
   -----------------------------*/
function showUnlockArea(show){
  $('#unlockArea').style.display = show ? 'block' : 'none';
}
function showWallet(show){
  $('#walletCard').style.display = show ? 'block' : 'none';
  $('#authCard').style.display = show ? 'none' : 'block';
}

/* generate */
$('#generateBtn').addEventListener('click', (e)=>{
  e.preventDefault();
  const kp = StellarSdk.Keypair.random();
  $('#genSecret').textContent = kp.secret();
  $('#genPublic').textContent = kp.publicKey();
  $('#generatedKeys').style.display = 'block';
});

/* import & save */
$('#importSaveBtn').addEventListener('click', async ()=>{
  const secret = $('#secretInput').value.trim();
  const pwd = $('#savePwd').value.trim();
  if(!secret || !pwd || pwd.length < 8){ alert('Enter secret and password (min 8 chars)'); return; }
  try{
    StellarSdk.Keypair.fromSecret(secret); // validate
    localStorage.setItem(STORE_KEY, encrypt(secret,pwd));
    await doLogin(secret);
  }catch(e){ alert('Invalid secret'); console.error(e); }
});

/* unlock saved */
$('#unlockBtn').addEventListener('click', async ()=>{
  const pwd = $('#unlockPwd').value.trim();
  const enc = localStorage.getItem(STORE_KEY);
  if(!enc){ alert('No saved wallet'); return; }
  const secret = decrypt(enc,pwd);
  if(!secret){ alert('Wrong password'); return; }
  await doLogin(secret);
});

/* forget saved */
$('#forgetBtn').addEventListener('click', ()=>{
  if(confirm('Forget saved wallet?')){ localStorage.removeItem(STORE_KEY); showUnlockArea(false); alert('Forgotten'); }
});

/* -----------------------------
   Login / Logout / Balances
   -----------------------------*/
async function doLogin(secret){
  try{
    keypair = StellarSdk.Keypair.fromSecret(secret);
    account = await server.loadAccount(keypair.publicKey());
    $('#pubKey').textContent = keypair.publicKey();
    showWallet(true);
    showUnlockArea(false);
    startPolling();
    await refreshBalances();
  }catch(err){
    console.error(err);
    if(err?.response?.status===404) alert('Account not found on mainnet. Fund with ≥2 XLM to activate.');
    else alert('Failed to load account. Check key and network.');
    // allow unlocking if saved
    if(localStorage.getItem(STORE_KEY)) showUnlockArea(true);
  }
}

$('#btnLock').addEventListener('click', ()=>{
  if(confirm('Lock wallet?')){ keypair=null; account=null; stopPolling(); showWallet(false); showUnlockArea(!!localStorage.getItem(STORE_KEY)); }
});

/* balances */
async function refreshBalances(){
  if(!keypair) return;
  try{
    account = await server.loadAccount(keypair.publicKey());
    let xlm=0, laam=0;
    for(const b of account.balances){
      if(b.asset_type === 'native') xlm = parseFloat(b.balance);
      if(b.asset_code === 'Laam' && b.asset_issuer === ISSUER) laam = parseFloat(b.balance);
    }
    $('#balXlm').textContent = fmt(xlm, 7);
    $('#balLaam').textContent = fmt(laam, 7);
    await updatePricesAndPortfolio(xlm, laam);
  }catch(e){ console.error('refreshBalances', e); }
}

/* Add trustline */
$('#btnTrust').addEventListener('click', async ()=>{
  if(!keypair || !account) return alert('Unlock wallet first');
  try{
    const fee = await server.fetchBaseFee();
    const tx = new StellarSdk.TransactionBuilder(account, {fee, networkPassphrase: StellarSdk.Networks.PUBLIC})
      .addOperation(StellarSdk.Operation.changeTrust({ asset: LAAM }))
      .setTimeout(30).build();
    tx.sign(keypair);
    const res = await server.submitTransaction(tx);
    alert('Trustline added. Tx: ' + res.hash);
    await refreshBalances();
  }catch(e){ console.error(e); alert('Failed to add trustline: ' + (e?.response?.data?.extras?.result_codes?.operations || e.message)); }
});

/* Send */
$('#btnSend').addEventListener('click', ()=>{
  if(!keypair) return alert('Unlock first');
  showSendModal();
});

/* Receive */
$('#btnReceive').addEventListener('click', ()=> toggleReceive(true));

function toggleReceive(show){
  $('#recvModal').classList.toggle('show', show);
  if(show && keypair){
    $('#recvPub').textContent = keypair.publicKey();
    const q = encodeURIComponent(keypair.publicKey());
    $('#openQr').href = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${q}`;
    $('#copyPub').onclick = ()=>navigator.clipboard.writeText(keypair.publicKey());
  }
}

/* simple send modal (native implementation uses prompt for brevity) */
async function showSendModal(){
  const asset = prompt('Asset to send (XLM or Laam)', 'XLM');
  if(!asset) return;
  const amount = prompt('Amount to send (e.g. 1.23)', '0.1');
  if(!amount) return;
  const dest = prompt('Destination public key (G...)', '');
  if(!dest) return;
  try{
    let txb = new StellarSdk.TransactionBuilder(account, {fee: await server.fetchBaseFee(), networkPassphrase: StellarSdk.Networks.PUBLIC});
    if(asset.toUpperCase() === 'XLM'){
      txb.addOperation(StellarSdk.Operation.payment({destination: dest, asset: XLM, amount: amount.toString()}));
    } else {
      txb.addOperation(StellarSdk.Operation.payment({destination: dest, asset: LAAM, amount: amount.toString()}));
    }
    const tx = txb.setTimeout(30).build();
    tx.sign(keypair);
    const res = await server.submitTransaction(tx);
    alert('Sent. Tx: ' + res.hash);
    await refreshBalances();
  }catch(e){ console.error(e); alert('Send failed: ' + e.message); }
}

/* -----------------------------
   Orderbook / Trades (polling)
   -----------------------------*/
async function loadOrderbook(){
  try{
    const ob = await server.orderbook(LAAM, XLM).call();
    bestAsk = ob.asks[0] || null;
    bestBid = ob.bids[0] || null;

    // display asks (sell offers) — show top 8
    $('#asksBody').innerHTML = (ob.asks.slice(0,8).map(a=>{
      const price = parseFloat(a.price); // price reported selling/buying — when calling LAAM vs XLM, Horizon price = LAAM per XLM? but we requested LAAM,XLM -> price = LAAM per XLM. To display XLM per Laam invert.
      // We called orderbook(LAAM, XLM) — Horizon returns price = (selling/buying) = LAAM per XLM. We want show XLM per Laam = 1/price.
      const priceXlmPerLaam = price === 0 ? 0 : 1 / price;
      const amountLaam = parseFloat(a.amount);
      const totalXlm = priceXlmPerLaam * amountLaam;
      return `<tr class="ask-row"><td>${amountLaam.toFixed(6)}</td><td>${priceXlmPerLaam.toFixed(7)}</td><td>${totalXlm.toFixed(7)}</td></tr>`;
    }).join('')) || '<tr><td colspan="3" class="small">No asks</td></tr>';

    // display bids (buy offers)
    $('#bidsBody').innerHTML = (ob.bids.slice(0,8).map(b=>{
      const price = parseFloat(b.price);
      const priceXlmPerLaam = price === 0 ? 0 : 1 / price;
      const amountLaam = parseFloat(b.amount);
      const totalXlm = priceXlmPerLaam * amountLaam;
      return `<tr class="bid-row"><td>${amountLaam.toFixed(6)}</td><td>${priceXlmPerLaam.toFixed(7)}</td><td>${totalXlm.toFixed(7)}</td></tr>`;
    }).join('')) || '<tr><td colspan="3" class="small">No bids</td></tr>';

    // update spread & overview price
    if(bestAsk && bestBid){
      const askP = 1 / parseFloat(bestAsk.price);
      const bidP = 1 / parseFloat(bestBid.price);
      const spread = askP - bidP;
      $('#spreadText').textContent = `Spread: ${spread.toFixed(7)} XLM`;
      $('#laamPriceXlm').textContent = ((askP + bidP) / 2).toFixed(7);
    } else if (bestAsk){
      $('#laamPriceXlm').textContent = (1 / parseFloat(bestAsk.price)).toFixed(7);
      $('#spreadText').textContent = 'Spread: -';
    } else if (bestBid){
      $('#laamPriceXlm').textContent = (1 / parseFloat(bestBid.price)).toFixed(7);
      $('#spreadText').textContent = 'Spread: -';
    } else {
      $('#laamPriceXlm').textContent = '0.0000000';
      $('#spreadText').textContent = 'Spread: -';
    }
  }catch(e){ console.error('loadOrderbook', e); $('#asksBody').innerHTML = '<tr><td colspan="3" class="small">Error</td></tr>'; $('#bidsBody').innerHTML = '<tr><td colspan="3" class="small">Error</td></tr>'; }
}

async function loadLastTrades(){
  try{
    const trades = await server.trades().forAssetPair(LAAM, XLM).limit(10).order('desc').call();
    $('#tradesBody').innerHTML = trades.records.map(r=>{
      const price = (parseFloat(r.price.n) / parseFloat(r.price.d));
      const amount = parseFloat(r.base_amount);
      const when = new Date(r.ledger_close_time || Date.now()).toLocaleString();
      return `<tr><td>${when}</td><td>${price.toFixed(7)}</td><td>${amount.toFixed(6)}</td></tr>`;
    }).join('');
  }catch(e){ console.error('loadLastTrades', e); $('#tradesBody').innerHTML = '<tr><td colspan="3">Error</td></tr>'; }
}

/* -----------------------------
   Buy / Sell logic (modal)
   -----------------------------*/
let currentTradeMode = 'buy'; // 'buy' or 'sell'

$('#openBuy').addEventListener('click', ()=>openTradeModal('buy'));
$('#openSell').addEventListener('click', ()=>openTradeModal('sell'));

function openTradeModal(mode){
  currentTradeMode = mode;
  $('#tradeModal').classList.add('show');
  $('#modalTitle').textContent = mode === 'buy' ? 'Buy Laam' : 'Sell Laam';
  // set avail balance
  if(account){
    let xlm=0, laam=0;
    for(const b of account.balances){
      if(b.asset_type === 'native') xlm = parseFloat(b.balance);
      if(b.asset_code==='Laam' && b.asset_issuer===ISSUER) laam = parseFloat(b.balance);
    }
    $('#availBal').textContent = mode === 'buy' ? `${fmt(xlm,7)} XLM` : `${fmt(laam,7)} Laam`;
  }
  // set default price
  const uiPrice = $('#laamPriceXlm').textContent || '0.135';
  $('#modalPrice').value = parseFloat(uiPrice) || 0.135;
  $('#modalAmount').value = '';
  $('#modalTotal').value = '';
}

/* modal fill percentages */
$$('.panel .rowBtns button').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    const pct = parseInt(e.target.dataset.fill);
    if(!account) return;
    let xlm=0, laam=0;
    for(const b of account.balances){
      if(b.asset_type === 'native') xlm = parseFloat(b.balance);
      if(b.asset_code==='Laam' && b.asset_issuer===ISSUER) laam = parseFloat(b.balance);
    }
    const price = parseFloat($('#modalPrice').value) || 0;
    if(currentTradeMode === 'buy'){
      // calculate max laam = (xlm * pct/100) / price
      const maxLaam = price>0 ? (xlm * pct/100) / price : 0;
      $('#modalAmount').value = maxLaam.toFixed(7);
    } else {
      const amt = (laam * pct/100);
      $('#modalAmount').value = amt.toFixed(7);
    }
    calculateModalTotal();
  });
});

/* calculate total */
$('#modalPrice').addEventListener('input', calculateModalTotal);
$('#modalAmount').addEventListener('input', calculateModalTotal);
function calculateModalTotal(){
  const price = parseFloat($('#modalPrice').value) || 0;
  const amount = parseFloat($('#modalAmount').value) || 0;
  if(currentTradeMode === 'buy'){
    // user wants to BUY Laam: total XLM = amount * price
    $('#modalTotal').value = (amount * price).toFixed(7);
    $('#modalHint').textContent = 'Total XLM you will pay';
  } else {
    // SELL Laam: total XLM = amount * price (but selling uses inverted price param in manageSellOffer)
    $('#modalTotal').value = (amount * price).toFixed(7);
    $('#modalHint').textContent = 'Total XLM you will receive (approx)';
  }
}

/* confirm trade */
$('#confirmTrade').addEventListener('click', async ()=>{
  if(!keypair || !account) return alert('Unlock wallet first');
  const priceUi = parseFloat($('#modalPrice').value);
  const amountLaam = parseFloat($('#modalAmount').value);
  if(!priceUi || !amountLaam) return alert('Enter price and amount');

  try{
    const fee = await server.fetchBaseFee();
    if(currentTradeMode === 'buy'){
      // BUY Laam: use manageBuyOffer: selling XLM, buying LAAM, buyAmount = amountLaam, price = XLM per Laam (UI)
      const txb = new StellarSdk.TransactionBuilder(account, {fee, networkPassphrase: StellarSdk.Networks.PUBLIC})
        .addOperation(StellarSdk.Operation.manageBuyOffer({
          selling: XLM,
          buying: LAAM,
          buyAmount: amountLaam.toFixed(7),
          price: priceUi.toString(),
          offerId: '0'
        }))
        .setTimeout(30).build();
      txb.sign(keypair);
      const res = await server.submitTransaction(txb);
      alert('Buy order placed. Tx: ' + res.hash);
    } else {
      // SELL Laam: use manageSellOffer: selling LAAM, buying XLM
      // Horizon expects price as selling/buying (Laam per XLM) so invert UI price (XLM per Laam) => priceLaamPerXlm = 1 / priceUi
      const priceLaamPerXlm = priceUi === 0 ? '0' : (1 / priceUi).toString();
      const txb = new StellarSdk.TransactionBuilder(account, {fee, networkPassphrase: StellarSdk.Networks.PUBLIC})
        .addOperation(StellarSdk.Operation.manageSellOffer({
          selling: LAAM,
          buying: XLM,
          amount: amountLaam.toFixed(7),
          price: priceLaamPerXlm,
          offerId: '0'
        }))
        .setTimeout(30).build();
      txb.sign(keypair);
      const res = await server.submitTransaction(txb);
      alert('Sell order placed. Tx: ' + res.hash);
    }
    // refresh
    await refreshBalances();
    await loadOrderbook();
    await loadLastTrades();
  }catch(e){
    console.error('trade error', e);
    const code = e?.response?.data?.extras?.result_codes;
    alert('Trade failed: ' + (code?.operations || e.message || JSON.stringify(e)));
  } finally {
    closeTradeModal();
  }
});

function closeTradeModal(){ $('#tradeModal').classList.remove('show'); }

/* -----------------------------
   Polling / start / stop
   -----------------------------*/
async function pollAll(){
  await loadOrderbook();
  await loadLastTrades();
  if(keypair) await refreshBalances();
}
function startPolling(){
  pollAll();
  pollTimer = setInterval(pollAll, 10000);
}
function stopPolling(){
  if(pollTimer){ clearInterval(pollTimer); pollTimer=null; }
}

/* update prices & portfolio calc */
async function updatePricesAndPortfolio(xlmBal=0, laamBal=0){
  // XLM -> USD rate from CoinGecko (simple fetch)
  let xlmUsd = 0;
  try{
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=stellar&vs_currencies=usd');
    const j = await r.json();
    xlmUsd = j?.stellar?.usd || 0;
  }catch(e){ xlmUsd = 0; }

  const laamPriceXlm = (bestAsk && bestBid) ? ((1/parseFloat(bestAsk.price) + 1/parseFloat(bestBid.price))/2) : (bestAsk ? 1/parseFloat(bestAsk.price) : (bestBid? 1/parseFloat(bestBid.price): 0));
  $('#laamPriceXlm').textContent = laamPriceXlm ? laamPriceXlm.toFixed(7) : '0.0000000';

  const laamUsd = laamPriceXlm * xlmUsd;
  const xlmUsdVal = xlmBal * xlmUsd;
  const laamUsdVal = laamBal * laamUsd;

  $('#xlmUsdPrice').textContent = xlmUsd.toFixed(4) || '0.0000';
  $('#laamUsdPrice').textContent = laamUsd.toFixed(4) || '0.0000';

  $('#xlmUsdVal').textContent = xlmUsdVal.toFixed(2);
  $('#laamUsdVal').textContent = laamUsdVal.toFixed(2);

  $('#portfolioUsd').textContent = (xlmUsdVal + laamUsdVal).toFixed(2);
  $('#breakdownText').textContent = `XLM $${xlmUsdVal.toFixed(2)} + Laam $${laamUsdVal.toFixed(2)}`;
}

/* -----------------------------
   Tabs & initial load
   -----------------------------*/
$('#tabOverview').addEventListener('click', ()=>{
  $$('#tabOverview, #tabOrderbook, #tabTrades').forEach(t=>t.classList.remove('active'));
  $('#tabOverview').classList.add('active');
  $('#overviewPanel').style.display='block';
  $('#orderbookPanel').style.display='none';
  $('#tradesPanel').style.display='none';
});
$('#tabOrderbook').addEventListener('click', ()=>{
  $$('#tabOverview, #tabOrderbook, #tabTrades').forEach(t=>t.classList.remove('active'));
  $('#tabOrderbook').classList.add('active');
  $('#overviewPanel').style.display='none';
  $('#orderbookPanel').style.display='block';
  $('#tradesPanel').style.display='none';
});
$('#tabTrades').addEventListener('click', ()=>{
  $$('#tabOverview, #tabOrderbook, #tabTrades').forEach(t=>t.classList.remove('active'));
  $('#tabTrades').classList.add('active');
  $('#overviewPanel').style.display='none';
  $('#orderbookPanel').style.display='none';
  $('#tradesPanel').style.display='block';
});

/* -----------------------------
   Initial data loads
   -----------------------------*/
async function loadInitial(){
  await loadOrderbook();
  await loadLastTrades();
  // if saved wallet exists — show unlock area
  if(localStorage.getItem(STORE_KEY)){
    showUnlockArea(true);
  }
}
loadInitial();

/* -----------------------------
   Periodic polling on page active
   -----------------------------*/
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'visible' && pollTimer == null) pollAll();
});

/* -----------------------------
   loadOrderbook & loadLastTrades are defined above
   -----------------------------*/
</script>
</body>
</html>
